<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Coder-Hohenheim</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Coder-Hohenheim</h1><a id="logo" href="/.">Coder-Hohenheim</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title"><a href="/2018/02/15/Spring-Boot-集成-Druid-Mybatis/">Spring Boot 集成 Druid + Mybatis</a></h1><div class="post-meta">2018-02-15</div><div class="post-content"><font face="微软雅黑" size="4"><br><br>最近把一个项目的框架由 SpringMVC 转为 Spring Boot，顺便作为学习 Spring Boot 的入门实践。框架的使用入门很快，尤其是 Spring Boot 其实相当于对 SpringMVC 做了一些改进，去除配置，改为代码约定。<br><br>但是，没了配置，第三方库如何集成进来就是 Spring Boot 入门学习遇到的第一个坎，尤其是一些没有官方支持 Spring Boot 的库。我把我的项目框架转为 Spring Boot 的时候，就遇到了 Druid 和 Mybatis 集成的问题，Mybatis 有支持 Spring Boot 的包，Druid 没有，所以 Druid 的集成就略显麻烦一点。我搜索了很多其他人写的相关 Blog，结果发现很多人要么是互相抄，要么是语焉不详，只是贴出大版的代码，你照抄他的代码虽然也能集成成功，但是你只知其然，不知其所以然，或者有些代码根本是不必要的。<br><br>在走了不少弯路以及持续改进后，我最终以比较满意的结果集成 Druid + Mybatis，为此记录下来，作为个人对近期 Spring Boot 学习总结。本文是针对如何在 Spring Boot 中集成 Druid 和 Mybatis，所以读者必须先熟悉 Spring Boot、Druid 和 Mybatis，对于这三者的细节，不再展开描述。<br><br>### 引入 Druid 和  Mybatis包：<br><br>在项目 pom.xml 文件中，引入这两个库的 jar 包，其中数据库我是用 MySQL，所以我同时也引入了 MySQL 的驱动 jar 包<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.0.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Mybatis 的 jar 包引入的是直接支持 Spring Boot 的，如果是引入是下面的这个 Mybatis 包，就需要自己去实现 Mybais 的配置代码 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><br><br>### 集成 Druid：<br><br>Druid 是数据库连接池，负责管理数据库的连接，给Mybatis、JPA提供数据库的连接，所以先集成他进来。<br>首先在 Spring Boot 的配置文件中，配置好数据源的各种参数，我的配置文件使用的是 yml，如果你的配置文件为 Properties，请更换为对应的格式即可,我的配置如下：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">    datasource:</span></span><br><span class="line">        <span class="comment">#DruidDataSource 所需参数</span></span><br><span class="line"><span class="attr">        type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span> </span><br><span class="line"><span class="attr">        driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="attr">        url:</span> <span class="attr">jdbc:mysql://localhost:3306/test</span></span><br><span class="line"><span class="attr">        username:</span> <span class="string">数据库用户名</span> </span><br><span class="line">		<span class="attr">password:</span> <span class="string">数据库密码</span> </span><br><span class="line">		<span class="attr">initialSize:</span> <span class="number">3</span> </span><br><span class="line">		<span class="attr">minIdle:</span> <span class="number">3</span> </span><br><span class="line">		<span class="attr">maxActive:</span> <span class="number">30</span> </span><br><span class="line">		<span class="attr">maxWait:</span> <span class="number">15000</span> </span><br><span class="line">		<span class="attr">timeBetweenEvictionRunsMillis:</span> <span class="number">120000</span> </span><br><span class="line">		<span class="attr">minEvictableIdleTimeMillis:</span> <span class="number">300000</span> </span><br><span class="line">		<span class="attr">validationQuery:</span> <span class="string">SELECT</span> <span class="string">'x'</span> </span><br><span class="line">		<span class="attr">validationQueryTimeout:</span> <span class="number">1</span> <span class="comment">#单位：秒，检测连接是否有效的超时时间。底层调用jdbc Statement对象的void setQueryTimeout(int seconds)方法</span></span><br><span class="line">		<span class="attr">testWhileIdle:</span> <span class="literal">true</span> </span><br><span class="line">		<span class="attr">testOnBorrow:</span> <span class="literal">false</span> </span><br><span class="line">		<span class="attr">testOnReturn:</span> <span class="literal">false</span> </span><br><span class="line">		<span class="attr">poolPreparedStatements:</span> <span class="literal">false</span> </span><br><span class="line">		<span class="attr">maxPoolPreparedStatementPerConnectionSize:</span> <span class="number">20</span> </span><br><span class="line">		<span class="attr">removeAbandoned:</span> <span class="literal">true</span> </span><br><span class="line">		<span class="attr">removeAbandonedTimeoutMillis:</span> <span class="number">20000</span> </span><br><span class="line">		<span class="attr">logAbandoned:</span> <span class="literal">true</span> </span><br><span class="line">		<span class="attr">logDifferentThread:</span> <span class="literal">true</span> </span><br><span class="line">		<span class="attr">filters:</span> <span class="string">log4j,stat</span> </span><br><span class="line">		<span class="attr">connectionProperties:</span>  <span class="string">druid.stat.mergeSql=true;druid.stat.logSlowSql=true;druid.stat.slowSqlMillis=3000</span> </span><br><span class="line">		<span class="attr">useGlobalDataSourceStat:</span> <span class="literal">true</span> </span><br><span class="line">		<span class="comment"># Druid 监控 Servlet 配置参数 </span></span><br><span class="line">		<span class="attr">druidRegistrationUrl:</span> <span class="string">/druid/*</span> </span><br><span class="line">		<span class="attr">resetEnable:</span> <span class="literal">true</span> </span><br><span class="line">		<span class="attr">loginUsername:</span> <span class="string">监控后台登录名称</span> </span><br><span class="line">		<span class="attr">loginPassword:</span> <span class="string">监控后台登录密码</span> </span><br><span class="line">		<span class="comment"># Druid 监控过滤相关配置参数 </span></span><br><span class="line">		<span class="attr">filtersUrlPatterns:</span> <span class="string">/*</span> </span><br><span class="line">		<span class="attr">exclusions:</span>  <span class="string">'*.js,*.gif,*.jpg,*.jpeg,*.png,*.css,*.ico,*.jsp,/druid/*'</span> </span><br><span class="line">		<span class="attr">sessionStatMaxCount:</span> <span class="number">2000</span> </span><br><span class="line">		<span class="attr">sessionStatEnable:</span> <span class="literal">true</span> </span><br><span class="line">		<span class="attr">principalSessionName:</span> <span class="string">session_user_key</span> </span><br><span class="line">		<span class="attr">profileEnable:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><br><br>以上配置参数写好后，Druid 并未按照我们配置的参数进行初始化，因为 Druid 官方并未去实现相关代码，所以我们要自己去实现。<br><br>创建一个 DruidConfig 类，我们在这个类中获取配置文件里面的 spring.datasource 中配置的数据，通过 @Component 和 @ConfigurationProperties(prefix = “spring.datasource”) 注解，获取到了配置文件中的配置参数代码如下：<br><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">@ConfigurationProperties(prefix = <span class="string">"spring.datasource"</span>)</span><br><span class="line"><span class="keyword">public</span> class DruidConfig &#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(DruidConfig.class);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">String</span> driverClassName;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">String</span> url;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">String</span> username;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">String</span> password;</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">int</span> initialSize;</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">int</span> minIdle;</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">int</span> maxActive;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">long</span> maxWait;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">long</span> timeBetweenEvictionRunsMillis;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">long</span> minEvictableIdleTimeMillis;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">String</span> validationQuery;</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">boolean</span> testWhileIdle;</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">boolean</span> testOnBorrow;</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">boolean</span> testOnReturn;</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">boolean</span> poolPreparedStatements;</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">int</span> maxPoolPreparedStatementPerConnectionSize;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">long</span> removeAbandonedTimeoutMillis;</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">boolean</span> removeAbandoned;</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">boolean</span> logAbandoned;</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">boolean</span> logDifferentThread;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">String</span> filters;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">String</span> connectionProperties;</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">boolean</span> useGlobalDataSourceStat;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Druid 监控 Servlet 配置参数</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">String</span> druidRegistrationUrl;</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">boolean</span> resetEnable;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">String</span> loginUsername;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">String</span> loginPassword;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Filters 配置参数</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">String</span> filtersUrlPatterns;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">String</span> exclusions;</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">int</span> sessionStatMaxCount;</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">boolean</span> sessionStatEnable;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">String</span> principalSessionName;</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">boolean</span> profileEnable;</span><br><span class="line"></span><br><span class="line">	…… setter &amp; getter</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><br>紧接着就是根据参数，创建 DruidDataSource 了，在 DruidConfig 中，创建一个方法：<br><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">@Bean(initMethod = <span class="string">"init"</span>, destroyMethod = <span class="string">"close"</span>)</span><br><span class="line">@Primary</span><br><span class="line">public DruidDataSource dataSource() &#123;</span><br><span class="line">	DruidDataSource dataSource = new DruidDataSource();</span><br><span class="line">	dataSource.<span class="built_in">set</span>DriverClassName(driverClassName);</span><br><span class="line">	dataSource.<span class="built_in">set</span>Url(url);</span><br><span class="line">	dataSource.<span class="built_in">set</span>Username(username);</span><br><span class="line">	dataSource.<span class="built_in">set</span>Password(password);</span><br><span class="line">	dataSource.<span class="built_in">set</span>InitialSize(initialSize);</span><br><span class="line">	dataSource.<span class="built_in">set</span>M<span class="keyword">in</span>Idle(<span class="keyword">min</span>Idle);</span><br><span class="line">	dataSource.<span class="built_in">set</span>MaxActive(<span class="keyword">max</span>Active);</span><br><span class="line">	dataSource.<span class="built_in">set</span>MaxWait(<span class="keyword">max</span>Wait);</span><br><span class="line">	dataSource.<span class="built_in">set</span>TimeBetweenEvictionRunsMillis(timeBetweenEvictionRunsMillis);</span><br><span class="line">	dataSource.<span class="built_in">set</span>M<span class="keyword">in</span>EvictableIdleTimeMillis(<span class="keyword">min</span>EvictableIdleTimeMillis);</span><br><span class="line">	dataSource.<span class="built_in">set</span>ValidationQuery(validationQuery);</span><br><span class="line">	dataSource.<span class="built_in">set</span>TestWhileIdle(testWhileIdle);</span><br><span class="line">	dataSource.<span class="built_in">set</span>TestOnBorrow(testOnBorrow);</span><br><span class="line">	dataSource.<span class="built_in">set</span>TestOnReturn(testOnReturn);</span><br><span class="line">	dataSource.<span class="built_in">set</span>PoolPreparedStatements(poolPreparedStatements);</span><br><span class="line">	dataSource.<span class="built_in">set</span>MaxPoolPreparedStatementPerConnectionSize(<span class="keyword">max</span>PoolPreparedStatementPerConnectionSize);</span><br><span class="line">	dataSource.<span class="built_in">set</span>RemoveAbandonedTimeoutMillis(removeAbandonedTimeoutMillis);</span><br><span class="line">	dataSource.<span class="built_in">set</span>RemoveAbandoned(removeAbandoned);</span><br><span class="line">	dataSource.<span class="built_in">set</span>LogDifferentThread(<span class="keyword">log</span>DifferentThread);</span><br><span class="line"></span><br><span class="line">	try &#123;</span><br><span class="line">		dataSource.<span class="built_in">set</span>Filters(filters);</span><br><span class="line">	&#125;</span><br><span class="line">	catch(SQLException e) &#123;</span><br><span class="line">		e.printStackTrace();</span><br><span class="line">		logger.error(<span class="string">"Druid URL过滤设置失败"</span>, e);</span><br><span class="line">	&#125;</span><br><span class="line">	dataSource.<span class="built_in">set</span>ConnectionProperties(connectionProperties);</span><br><span class="line">	dataSource.<span class="built_in">set</span>UseGlobalDataSourceStat(useGlobalDataSourceStat);</span><br><span class="line"></span><br><span class="line">	return dataSource;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><br>这个方法，就是告诉框架，数据源是由这个方法来提供，注解 @Primary 意思是告诉框架，如果开发者没有指定其他数据源，那么就默认调用这个方法来提供数据源。这一步进行完，其实 Druid 的最核心的配置已经进行完毕，可以使用 Druid 来给 Mybatis 或者 JPA 提供数据库连接了，下面的 Druid 监控可根据实际需求进行配置。<br><br>+ 让 Druid 支持事务：通过上面的配置，虽然已经能提供数据库的连接来进行数据库操作了，但是开发过程中，除了调用 SQL，还会遇到调用数据库的事务，所以我们要让 Druid 支持事务才行，让 Druid 支持事务很简单，实现 Spring 的 TransactionManagementConfigurer 接口，重写该接口下的 annotationDrivenTransactionManager 方法，在这个方法里面给 DruidDataSource 开启事务，同时让这个类在 DruidConfig 被 Spring 加载之后，再去被 Spring 加载即可，代码如下：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Configuration</span></span><br><span class="line"><span class="variable">@EnableTransactionManagement</span></span><br><span class="line"><span class="variable">@AutoConfigureAfter</span>(&#123;DruidConfig.class&#125;)</span><br><span class="line"><span class="variable">@MapperScan</span>(basePackages = &#123;<span class="string">"Mybatis 的 DAO 接口所在的包路径"</span>&#125;)</span><br><span class="line">public class TransactionConfig implements TransactionManagementConfigurer &#123;</span><br><span class="line">	<span class="variable">@Autowired</span></span><br><span class="line">	private DruidDataSource mDataSource;</span><br><span class="line"></span><br><span class="line">	<span class="variable">@Override</span></span><br><span class="line">	public PlatformTransactionManager annotationDrivenTransactionManager() &#123;</span><br><span class="line">		<span class="selector-tag">return</span> <span class="selector-tag">new</span> <span class="selector-tag">DataSourceTransactionManager</span>(mDataSource);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><br>+ 配置 Druid 监控页面。Druid 提供了数据库链接状态和 SQL 执行的页面，方便开发者查看自己的程序的数据库连接与操作状态，这个监控后台的页面 Servlet 是 StatViewServlet，我们配置好他，就能打开监控后台查看数据了，在 DruidConfig 中，新增一个如下的方法：<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line"><span class="keyword">public</span> ServletRegistrationBean druidServlet() &#123;</span><br><span class="line">	ServletRegistrationBean servletBean = <span class="keyword">new</span> <span class="type">ServletRegistrationBean</span>(<span class="keyword">new</span> <span class="type">StatViewServlet</span>(), druidRegistrationUrl);</span><br><span class="line">	servletBean.addInitParameter(<span class="string">"resetEnable"</span>, <span class="keyword">String</span>.valueOf(resetEnable));</span><br><span class="line">	servletBean.addInitParameter(<span class="string">"loginUsername"</span>, loginUsername);</span><br><span class="line">	servletBean.addInitParameter(<span class="string">"loginPassword"</span>, loginPassword);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> servletBean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><br>添加这个方法后，重新启动项目，你就能在浏览器中输入 项目URL/你配置的Druid监控后台路径(就是上面druidRegistrationUrl变量) 来访问到 Druid 的监控后台了。<br><br>+ 现在是可以访问 Druid 的监控后台了，但是这样的配置不完美，还需要给监控后台加上一些过滤，避免一些没必要的资源和页面被统计进去，所以我们还要配置一个 WebStatFilter，关于 WebStatFilter 的配置参数，请查阅相关文档，我这里只是部分配置参数。我们在 DruidConfig 中，新增一个如下的方法：<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line"><span class="keyword">public</span> FilterRegistrationBean filterRegistration() &#123;</span><br><span class="line">	FilterRegistrationBean filterRegistrationBean = <span class="keyword">new</span> <span class="type">FilterRegistrationBean</span>(<span class="keyword">new</span> <span class="type">WebStatFilter</span>());</span><br><span class="line">	filterRegistrationBean.addUrlPatterns(filtersUrlPatterns);</span><br><span class="line">	filterRegistrationBean.addInitParameter(<span class="string">"exclusions"</span>, exclusions);</span><br><span class="line">	filterRegistrationBean.addInitParameter(<span class="string">"sessionStatMaxCount"</span>, <span class="keyword">String</span>.valueOf(sessionStatMaxCount));</span><br><span class="line">	filterRegistrationBean.addInitParameter(<span class="string">"sessionStatEnable"</span>, <span class="keyword">String</span>.valueOf(sessionStatEnable));</span><br><span class="line">	filterRegistrationBean.addInitParameter(<span class="string">"principalSessionName"</span>, principalSessionName);</span><br><span class="line">	filterRegistrationBean.addInitParameter(<span class="string">"profileEnable"</span>, <span class="keyword">String</span>.valueOf(profileEnable));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> filterRegistrationBean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><br>至此，Druid 的配置已全部完成。<br><br>### 集成 Mybatis：<br>Mybatis 的集成就要比 Druid 简单很多，因为我们引入的 org.mybatis.spring.boot 得包，已经帮我们实现了类似于 DruidConfig 的配置类了<br><img src="https://i.imgur.com/vT5OJ27.png" alt=""><br><br>所以我们只要在 Spring Boot 中配置好 Mybatis 的参数，写好你的 DAO 和 Service（如果你的 Mybatis 是使用 xml 来写 SQL 方式，就不用实现 Service，如果是注解，就要实现 DAO 的 Service），然后就能使用 Mybatis 了，配置如下，在你的 Spring Boot 中写上如下配置，注意，配置的参数要换上自己的，别照搬代码又不改成自己的参数，然后调用 Mybatis 进行操作发生异常时一头雾水：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mybatis:</span><br><span class="line">	config-location: classpath:/db/mybatis-config.xml</span><br><span class="line">    mapper-locations: classpath:/db/mappers<span class="comment">/**/</span>*Mapper.xml</span><br><span class="line">    type-aliases-package: com<span class="selector-class">.java</span><span class="selector-class">.springboot</span><span class="selector-class">.db</span><span class="selector-class">.entity</span></span><br></pre></td></tr></table></figure><br><br>### 结尾<br>至此，Spring Boot 集成 Druid 和 Mybatis 的工作已完成，至于里面的各个参数是什么意思，如何优化，不在本文范围之内，该文只说如何集成。如果文中有任何错误、改进方式，欢迎一起探讨。<br><br></font></div><p class="readmore"><a href="/2018/02/15/Spring-Boot-集成-Druid-Mybatis/">阅读全文</a></p></div><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
  });
</script><script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML" async></script></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://tqwboy.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java-Server/">Java Server</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Spring-Boot-Druid-Mybatis/" style="font-size: 15px;">Spring Boot,Druid,Mybatis</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/02/15/Spring-Boot-集成-Druid-Mybatis/">Spring Boot 集成 Druid + Mybatis</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">Coder-Hohenheim.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>