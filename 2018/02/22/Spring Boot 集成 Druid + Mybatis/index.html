<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title> | Hexo</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Hexo</h1><a id="logo" href="/.">Hexo</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title"></h1><div class="post-meta">Feb 22, 2018</div><div class="post-content"><h2 id="Spring-Boot-集成-Druid-Mybatis"><a href="#Spring-Boot-集成-Druid-Mybatis" class="headerlink" title="Spring Boot 集成 Druid + Mybatis"></a>Spring Boot 集成 Druid + Mybatis</h2><font face="微软雅黑" size="4"><br><br>最近把一个项目的框架由 SpringMVC 转为 Spring Boot，顺便作为学习 Spring Boot 的入门实践。框架的使用入门很快，尤其是 Spring Boot 其实相当于对 SpringMVC 做了一些改进，去除配置，改为代码约定。<br><br>但是，没了配置，第三方库如何集成进来就是 Spring Boot 入门学习遇到的第一个坎，尤其是一些没有官方支持 Spring Boot 的库。我把我的项目框架转为 Spring Boot 的时候，就遇到了 Druid 和 Mybatis 集成的问题，Mybatis 有支持 Spring Boot 的包，Druid 没有，所以 Druid 的集成就略显麻烦一点。我搜索了很多其他人写的相关 Blog，结果发现很多人要么是互相抄，要么是语焉不详，只是贴出大版的代码，你照抄他的代码虽然也能集成成功，但是你只知其然，不知其所以然，或者有些代码根本是不必要的。<br><br>在走了不少弯路以及持续改进后，我最终以比较满意的结果集成 Druid + Mybatis，为此记录下来，作为个人对近期 Spring Boot 学习总结。本文是针对如何在 Spring Boot 中集成 Druid 和 Mybatis，所以读者必须先熟悉 Spring Boot、Druid 和 Mybatis，对于这三者的细节，不再展开描述。<br><br>### 引入 Druid 和  Mybatis包：<br><br>在项目 pom.xml 文件中，引入这两个库的 jar 包，其中数据库我是用 MySQL，所以我同时也引入了 MySQL 的驱动 jar 包<br>#<br>    <dependency><br>        <groupid>mysql</groupid><br>        <artifactid>mysql-connector-java</artifactid><br>        <version>6.0.6</version><br>    </dependency><br><br>    <dependency><br>       <groupid>com.alibaba</groupid><br>       <artifactid>druid</artifactid><br>       <version>1.1.5</version><br>    </dependency><br><br>    <dependency><br>        <groupid>org.mybatis.spring.boot</groupid><br>        <artifactid>mybatis-spring-boot-starter</artifactid><br>        <version>1.3.1</version><br>    </dependency><br><br>    <!-- Mybatis 的 jar 包引入的是直接支持 Spring Boot 的，如果是引入是下面的这个 Mybatis 包，就需要自己去实现 Mybais 的配置代码 --><br>    <dependency><br>        <groupid>org.mybatis</groupid><br>        <artifactid>mybatis</artifactid><br>        <version>3.4.5</version><br>    </dependency><br><br>### 集成 Druid：<br><br>Druid 是数据库连接池，负责管理数据库的连接，给Mybatis、JPA提供数据库的连接，所以先集成他进来。<br>首先在 Spring Boot 的配置文件中，配置好数据源的各种参数，我的配置文件使用的是 yml，如果你的配置文件为 Properties，请更换为对应的格式即可,我的配置如下：<br>#<br>    spring:<br>        datasource:<br>            #DruidDataSource 所需参数<br>            type: com.alibaba.druid.pool.DruidDataSource<br>            driver-class-name: com.mysql.cj.jdbc.Driver<br>            url: jdbc:mysql://localhost:3306/test<br>            username: 数据库用户名<br>            password: 数据库密码<br>            initialSize: 3<br>            minIdle: 3<br>            maxActive: 30<br>            maxWait: 15000<br>            timeBetweenEvictionRunsMillis: 120000<br>            minEvictableIdleTimeMillis: 300000<br>            validationQuery: SELECT ‘x’<br>            testWhileIdle: true<br>            testOnBorrow: false<br>            testOnReturn: false<br>            poolPreparedStatements: false<br>            maxPoolPreparedStatementPerConnectionSize: 20<br>            removeAbandoned: true<br>            removeAbandonedTimeoutMillis: 20000<br>            logAbandoned: true<br>            logDifferentThread: true<br>            filters: log4j,stat<br>            connectionProperties:  druid.stat.mergeSql=true;druid.stat.logSlowSql=true;druid.stat.slowSqlMillis=3000<br>            useGlobalDataSourceStat: true<br>            # Druid 监控 Servlet 配置参数<br>            druidRegistrationUrl: /druid/<em><br>            resetEnable: true<br>            loginUsername: 监控后台登录名称<br>            loginPassword: 监控后台登录密码<br>            # Druid 监控过滤相关配置参数<br>            filtersUrlPatterns: /</em><br>            exclusions: <em>.js,</em>.gif,<em>.jpg,</em>.jpeg,<em>.png,</em>.css,<em>.ico,</em>.jsp,/druid/<em><br>            sessionStatMaxCount: 2000<br>            sessionStatEnable: true<br>            principalSessionName: session_user_key<br>            profileEnable: true<br><br>以上配置参数写好后，Druid 并未按照我们配置的参数进行初始化，因为 Druid 官方并未去实现相关代码，所以我们要自己去实现。<br><br>创建一个 DruidConfig 类，我们在这个类中获取配置文件里面的 spring.datasource 中配置的数据，通过 @Component 和 @ConfigurationProperties(prefix = “spring.datasource”) 注解，获取到了配置文件中的配置参数代码如下：<br>#<br>    @Component<br>    @ConfigurationProperties(prefix = “spring.datasource”)<br>    public class DruidConfig {<br>        private final Logger logger = LoggerFactory.getLogger(DruidConfig.class);<br><br>        private String driverClassName;<br>        private String url;<br>        private String username;<br>        private String password;<br>        private int initialSize;<br>        private int minIdle;<br>        private int maxActive;<br>        private long maxWait;<br>        private long timeBetweenEvictionRunsMillis;<br>        private long minEvictableIdleTimeMillis;<br>        private String validationQuery;<br>        private boolean testWhileIdle;<br>        private boolean testOnBorrow;<br>        private boolean testOnReturn;<br>        private boolean poolPreparedStatements;<br>        private int maxPoolPreparedStatementPerConnectionSize;<br>        private long removeAbandonedTimeoutMillis;<br>        private boolean removeAbandoned;<br>        private boolean logAbandoned;<br>        private boolean logDifferentThread;<br>        private String filters;<br>        private String connectionProperties;<br>        private boolean useGlobalDataSourceStat;<br><br>        //Druid 监控 Servlet 配置参数<br>        private String druidRegistrationUrl;<br>        private boolean resetEnable;<br>        private String loginUsername;<br>        private String loginPassword;<br><br>        // Filters 配置参数<br>        private String filtersUrlPatterns;<br>        private String exclusions;<br>        private int sessionStatMaxCount;<br>        private boolean sessionStatEnable;<br>        private String principalSessionName;<br>        private boolean profileEnable;<br><br>        …… setter &amp; getter<br>    }<br><br>紧接着就是根据参数，创建 DruidDataSource 了，在 DruidConfig 中，创建一个方法：<br>#<br>    @Bean(initMethod = “init”, destroyMethod = “close”)<br>    @Primary<br>    public DruidDataSource dataSource() {<br>        DruidDataSource dataSource = new DruidDataSource();<br>        dataSource.setDriverClassName(driverClassName);<br>        dataSource.setUrl(url);<br>        dataSource.setUsername(username);<br>        dataSource.setPassword(password);<br>        dataSource.setInitialSize(initialSize);<br>        dataSource.setMinIdle(minIdle);<br>        dataSource.setMaxActive(maxActive);<br>        dataSource.setMaxWait(maxWait);<br>        dataSource.setTimeBetweenEvictionRunsMillis(timeBetweenEvictionRunsMillis);<br>        dataSource.setMinEvictableIdleTimeMillis(minEvictableIdleTimeMillis);<br>        dataSource.setValidationQuery(validationQuery);<br>        dataSource.setTestWhileIdle(testWhileIdle);<br>        dataSource.setTestOnBorrow(testOnBorrow);<br>        dataSource.setTestOnReturn(testOnReturn);<br>        dataSource.setPoolPreparedStatements(poolPreparedStatements);<br>        dataSource.setMaxPoolPreparedStatementPerConnectionSize(maxPoolPreparedStatementPerConnectionSize);<br>        dataSource.setRemoveAbandonedTimeoutMillis(removeAbandonedTimeoutMillis);<br>        dataSource.setRemoveAbandoned(removeAbandoned);<br>        dataSource.setLogDifferentThread(logDifferentThread);<br><br>        try {<br>            dataSource.setFilters(filters);<br>        }<br>        catch(SQLException e) {<br>            e.printStackTrace();<br>            logger.error(“Druid URL过滤设置失败”, e);<br>        }<br>        dataSource.setConnectionProperties(connectionProperties);<br>        dataSource.setUseGlobalDataSourceStat(useGlobalDataSourceStat);<br><br>        return dataSource;<br>    }<br><br>这个方法，就是告诉框架，数据源是由这个方法来提供，注解 @Primary 意思是告诉框架，如果开发者没有指定其他数据源，那么就默认调用这个方法来提供数据源。这一步进行完，其实 Druid 的最核心的配置已经进行完毕，可以使用 Druid 来给 Mybatis 或者 JPA 提供数据库连接了，下面的 Druid 监控可根据实际需求进行配置。<br><br>+ 让 Druid 支持事务：通过上面的配置，虽然已经能提供数据库的连接来进行数据库操作了，但是开发过程中，除了调用 SQL，还会遇到调用数据库的事务，所以我们要让 Druid 支持事务才行，让 Druid 支持事务很简单，实现 Spring 的 TransactionManagementConfigurer 接口，重写该接口下的 annotationDrivenTransactionManager 方法，在这个方法里面给 DruidDataSource 开启事务，同时让这个类在 DruidConfig 被 Spring 加载之后，再去被 Spring 加载即可，代码如下：<br>#<br>    @Configuration<br>    @EnableTransactionManagement<br>    @AutoConfigureAfter({DruidConfig.class})<br>    @MapperScan(basePackages = {“Mybatis 的 DAO 接口所在的包路径”})<br>    public class TransactionConfig implements     TransactionManagementConfigurer {<br>        @Autowired<br>        private DruidDataSource mDataSource;<br><br>        @Override<br>        public PlatformTransactionManager annotationDrivenTransactionManager() {<br>            return new DataSourceTransactionManager(mDataSource);<br>        }<br>    }<br><br>+ 配置 Druid 监控页面。Druid 提供了数据库链接状态和 SQL 执行的页面，方便开发者查看自己的程序的数据库连接与操作状态，这个监控后台的页面 Servlet 是 StatViewServlet，我们配置好他，就能打开监控后台查看数据了，在 DruidConfig 中，新增一个如下的方法：<br>#<br>    @Bean<br>    public ServletRegistrationBean druidServlet() {<br>        ServletRegistrationBean servletBean = new ServletRegistrationBean(new StatViewServlet(), druidRegistrationUrl);<br>        servletBean.addInitParameter(“resetEnable”, String.valueOf(resetEnable));<br>        servletBean.addInitParameter(“loginUsername”, loginUsername);<br>        servletBean.addInitParameter(“loginPassword”, loginPassword);<br><br>        return servletBean;<br>    }<br>添加这个方法后，重新启动项目，你就能在浏览器中输入 项目URL/你配置的Druid监控后台路径(就是上面druidRegistrationUrl变量) 来访问到 Druid 的监控后台了。<br><br>+ 现在是可以访问 Druid 的监控后台了，但是这样的配置不完美，还需要给监控后台加上一些过滤，避免一些没必要的资源和页面被统计进去，所以我们还要配置一个 WebStatFilter，关于 WebStatFilter 的配置参数，请查阅相关文档，我这里只是部分配置参数。我们在 DruidConfig 中，新增一个如下的方法：<br>#<br>    @Bean<br>    public FilterRegistrationBean filterRegistration() {<br>        FilterRegistrationBean filterRegistrationBean = new FilterRegistrationBean(new WebStatFilter());<br>        filterRegistrationBean.addUrlPatterns(filtersUrlPatterns);<br>        filterRegistrationBean.addInitParameter(“exclusions”, exclusions);<br>        filterRegistrationBean.addInitParameter(“sessionStatMaxCount”, String.valueOf(sessionStatMaxCount));<br>        filterRegistrationBean.addInitParameter(“sessionStatEnable”, String.valueOf(sessionStatEnable));<br>        filterRegistrationBean.addInitParameter(“principalSessionName”, principalSessionName);<br>        filterRegistrationBean.addInitParameter(“profileEnable”, String.valueOf(profileEnable));<br><br>        return filterRegistrationBean;<br>    }<br>至此，Druid 的配置已全部完成。<br><br>### 集成 Mybatis：<br>Mybatis 的集成就要比 Druid 简单很多，因为我们引入的 org.mybatis.spring.boot 得包，已经帮我们实现了类似于 DruidConfig 的配置类了<br><img src="https://i.imgur.com/vT5OJ27.png" alt=""><br><br>所以我们只要在 Spring Boot 中配置好 Mybatis 的参数，写好你的 DAO 和 Service（如果你的 Mybatis 是使用 xml 来写 SQL 方式，就不用实现 Service，如果是注解，就要实现 DAO 的 Service），然后就能使用 Mybatis 了，配置如下，在你的 Spring Boot 中写上如下配置，注意，配置的参数要换上自己的，别照搬代码又不改成自己的参数，然后调用 Mybatis 进行操作发生异常时一头雾水：<br>#<br>    mybatis:<br>        config-location: classpath:/db/mybatis-config.xml<br>        mapper-locations: classpath:/db/mappers/**/</em>Mapper.xml<br>        type-aliases-package: com.java.springboot.db.entity<br><br><br>### 结尾<br>至此，Spring Boot 集成 Druid 和 Mybatis 的工作已完成，至于里面的各个参数是什么意思，如何优化，不在本文范围之内，该文只说如何集成。如果文中有任何错误、改进方式，欢迎一起探讨。<br><br></font></div><div class="tags"></div><div class="post-nav"><a class="next" href="/2018/02/15/Spring-Boot-集成-Druid-Mybatis/">Spring Boot 集成 Druid + Mybatis</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java-Server/">Java Server</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Spring-Boot-Druid-Mybatis/" style="font-size: 15px;">Spring Boot,Druid,Mybatis</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/02/22/Spring Boot 集成 Druid + Mybatis/">Spring Boot 集成 Druid + Mybatis</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/02/15/Spring-Boot-集成-Druid-Mybatis/">Spring Boot 集成 Druid + Mybatis</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">Hexo.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>